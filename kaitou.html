<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; --gap: 10px; }

  html, body {
    margin: 0;
    background: #fff;
    color: #111;
    font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
    overscroll-behavior-y: contain;
    overflow-x: hidden; /* ページ全体の左右スクロール禁止 */
  }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 0 12px; }

  /* ===== カルーセル（4ボタン＋テキストチップ＋右端ツール） ===== */
  .toc-dock{
    position:fixed; top:0; left:0; right:0; z-index:1000;
    background:#fff; border-bottom:1px solid #eee;
    padding:8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar{ display:flex; align-items:center; gap:10px; }
  .btn{
    height:34px; padding:0 12px; border:1px solid #ddd; border-radius:999px;
    background:#f9fafb; color:#111; cursor:pointer;
  }
  .btn:disabled{ opacity:.4; cursor:default; }

  .toc-container{ flex:1; overflow:hidden; }
  .toc{ overflow-x:auto; overflow-y:hidden; white-space:nowrap; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
  .toc::-webkit-scrollbar{ display:none; }
  .toc-list{ display:flex; gap:8px; padding:0; margin:0; list-style:none; }
  .toc-list a{
    display:inline-block; padding:6px 12px; border:1px solid #ddd; border-radius:999px;
    background:#f0f6ff; color:#0366d6; text-decoration:none; user-select:none;
  }
  .toc-list a.active{ background:#e7f1ff; border-color:#cfe3ff; }

  .toolbar-right{ display:flex; gap:8px; align-items:center; }

  /* ===== 本文 ===== */
  main{ padding-top: calc(var(--dock-h) + 12px); padding-bottom: 48px; }
  section{ padding: 18px 0; border-bottom: 1px solid #f0f0f0; scroll-margin-top: calc(var(--dock-h) + 8px); }

  .viewer-inner{ padding: 0 0 12px 0; box-sizing: border-box; }

  /* 画像枠はデバイス横幅と同じ（フルブリード） */
  .frame{
    position:relative; overflow:hidden;
    width:100vw; max-width:100vw; box-sizing:border-box;
    margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw);
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    touch-action: pan-y; /* 1倍時は縦スクロールを許可（ズーム時はJSで none に切替） */
  }
  .frame img{
    display:block; width:100%; height:auto;
    user-select:none; -webkit-user-drag:none; pointer-events:none; /* 画像タップ無効 */
    transform-origin:0 0; will-change:transform;
  }
  .badge{
    position:absolute; right:10px; bottom:10px;
    background:rgba(0,0,0,.55); color:#fff;
    border:1px solid rgba(255,255,255,.12);
    padding:4px 8px; border-radius:8px; font-size:12px;
  }
</style>
</head>
<body>
  <!-- ===== カルーセル ===== -->
  <div class="toc-dock" id="toc-dock" role="region" aria-label="目次">
    <div class="wrap">
      <div class="toc-bar">
        <!-- 左：カルーセル操作 2つ -->
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <!-- 中央：テキストチップ -->
        <div class="toc-container">
          <nav class="toc" id="toc" aria-label="ページリスト（横スクロール）">
            <ul class="toc-list" id="toc-list"></ul>
          </nav>
        </div>

        <!-- 右端：ページ送り ← → ／ 2倍↔1倍 ／ 原寸 -->
        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE = "docs/";
const groups = [
  { prefix: "1-", start: 1, end: 15 },
  { prefix: "2-", start: 1, end: 12 },
  { prefix: "3-", start: 1, end: 11 },
];
const pad3 = n => String(n).padStart(3, "0");
const files = groups.flatMap(g => Array.from({length: g.end - g.start + 1}, (_,i)=>`${g.prefix}${pad3(g.start+i)}.jpeg`));

/* ========= 要素 ========= */
const tocEl   = document.getElementById('toc');
const tocList = document.getElementById('toc-list');
const content = document.getElementById('content');
const btnOpen = document.getElementById('btn-open');
const btnZoom = document.getElementById('btn-zoom');
const pgPrev  = document.getElementById('pg-prev');
const pgNext  = document.getElementById('pg-next');
const carPrev = document.getElementById('car-prev');
const carNext = document.getElementById('car-next');

/* ========= セクション生成 ========= */
files.forEach((name, idx) => {
  // TOC チップ
  const li = document.createElement('li');
  const a  = document.createElement('a');
  a.href = `#p-${name.replace(/\.[^.]+$/, "")}`;
  a.dataset.index = idx;
  a.textContent = name.replace('.jpeg','');
  if (idx === 0) a.classList.add('active');
  li.appendChild(a); tocList.appendChild(li);

  // セクション（フルブリード画像枠）
  const sec = document.createElement('section');
  sec.dataset.index = idx; sec.id = `p-${name.replace(/\.[^.]+$/, "")}`;
  sec.innerHTML = `
    <div class="viewer-inner">
      <figure class="frame" data-zoomable>
        <img src="${BASE}${encodeURIComponent(name)}" alt="">
        <div class="badge">1.00×</div>
      </figure>
    </div>
  `;
  content.appendChild(sec);
});

/* ========= カルーセル高さを CSS 変数へ ========= */
const dockEl = document.getElementById('toc-dock');
function applyDockH(){ document.documentElement.style.setProperty('--dock-h', (dockEl?.offsetHeight||0) + 'px'); }
new ResizeObserver(applyDockH).observe(dockEl);
window.addEventListener('resize', applyDockH);
applyDockH();

/* ========= 現在ページ同期 ========= */
const sections = Array.from(document.querySelectorAll('main section'));
const tocLinks = Array.from(document.querySelectorAll('#toc-list a'));
function indexByScroll(){
  const y = window.scrollY;
  let best=0, dist=Infinity;
  sections.forEach((s,i)=>{ const d = Math.abs(s.offsetTop - y); if (d<dist){dist=d; best=i;} });
  return best;
}
function markActive(i){
  tocLinks.forEach((el,idx)=>el.classList.toggle('active', idx===i));
  const img = sections[i]?.querySelector('img');
  if (img) btnOpen.href = img.currentSrc || img.src;
}
function scrollToSection(i, smooth=true){
  const s = sections[i]; if (!s) return;
  const y = s.offsetTop;
  window.scrollTo({ top: y, behavior: smooth ? 'smooth' : 'auto' });
  markActive(i);
}
tocLinks.forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); scrollToSection(Number(a.dataset.index)); }));
pgPrev.addEventListener('click', ()=>{ const i=indexByScroll(); if (i>0) scrollToSection(i-1); });
pgNext.addEventListener('click', ()=>{ const i=indexByScroll(); if (i<sections.length-1) scrollToSection(i+1); });
window.addEventListener('scroll', ()=>markActive(indexByScroll()), {passive:true});

/* ========= カルーセル左右（≪ ≫） ========= */
function pageSize(){ return Math.max(200, tocEl.clientWidth * 0.8); }
carPrev.addEventListener('click', ()=> tocEl.scrollBy({left:-pageSize(), behavior:'smooth'}));
carNext.addEventListener('click', ()=> tocEl.scrollBy({left: pageSize(), behavior:'smooth'}));

/* ========= 画像ズーム（2倍↔1倍）と 2倍中の1本指パン ========= */
const frameStates = new WeakMap(); // frame -> {scale,x,y,isDragging,startX,startY,nW,nH}

function getState(frame){
  if (!frameStates.has(frame)) frameStates.set(frame, { scale:1, x:0, y:0, isDragging:false, startX:0, startY:0, nW:0, nH:0 });
  return frameStates.get(frame);
}
function applyTransform(frame){
  const st = getState(frame);
  const img = frame.querySelector('img');
  img.style.transform = `translate(${st.x}px, ${st.y}px) scale(${st.scale})`;
  frame.querySelector('.badge').textContent = `${st.scale.toFixed(2)}×`;
}
function clamp(frame){
  const st = getState(frame);
  const img = frame.querySelector('img');
  const nW = st.nW || img.naturalWidth;
  const nH = st.nH || img.naturalHeight;
  if (!nW || !nH) return;

  const fw = frame.clientWidth;
  const fh = frame.clientHeight; // 高さは画像比から算出されるが、表示域として使う

  const baseW = fw;
  const baseH = baseW * (nH / nW);
  const dispW = baseW * st.scale;
  const dispH = baseH * st.scale;

  const minX = Math.min(0, fw - dispW), maxX = 0;
  const minY = Math.min(0, fh - dispH), maxY = 0;

  st.x = Math.max(minX, Math.min(maxX, st.x));
  st.y = Math.max(minY, Math.min(maxY, st.y));
}

function enterZoom(frame){
  const st = getState(frame);
  const img = frame.querySelector('img');
  // 画像自然サイズを保持
  st.nW = img.naturalWidth; st.nH = img.naturalHeight;

  st.scale = 2; st.x = 0; st.y = 0;
  clamp(frame); applyTransform(frame);

  // ページ固定（縦スクロール無効）
  document.documentElement.style.overflowY = 'hidden';
  document.body.style.overflowY = 'hidden';
  frame.style.touchAction = 'none'; // ページのスクロールも無効化

  // 1本指パン（ズーム中のみ）
  const onDown = (e) => {
    // 2本指・ピンチ禁止
    if (e.pointerType === 'touch' && e.isPrimary === false) { e.preventDefault(); return; }
    e.preventDefault();
    st.isDragging = true;
    frame.setPointerCapture(e.pointerId);
    st.startX = e.clientX - st.x;
    st.startY = e.clientY - st.y;
  };
  const onMove = (e) => {
    if (!st.isDragging) return;
    e.preventDefault();
    st.x = e.clientX - st.startX;
    st.y = e.clientY - st.startY;
    clamp(frame); applyTransform(frame);
  };
  const onUp = (e) => {
    if (!st.isDragging) return;
    st.isDragging = false;
    try { frame.releasePointerCapture(e.pointerId); } catch(_) {}
  };

  // 保存して後で解除
  st._handlers = { onDown, onMove, onUp };
  frame.addEventListener('pointerdown', onDown, { passive:false });
  frame.addEventListener('pointermove', onMove, { passive:false });
  frame.addEventListener('pointerup', onUp, { passive:false });
  frame.addEventListener('pointercancel', onUp, { passive:false });
}
function exitZoom(frame){
  const st = getState(frame);
  st.scale = 1; st.x = 0; st.y = 0;
  applyTransform(frame);

  // ページスクロールを元に
  document.documentElement.style.overflowY = 'auto';
  document.body.style.overflowY = 'auto';
  frame.style.touchAction = 'pan-y'; // 画像部分から1本指スクロールOK

  // パン用ハンドラ解除
  if (st._handlers){
    frame.removeEventListener('pointerdown', st._handlers.onDown, { passive:false });
    frame.removeEventListener('pointermove', st._handlers.onMove, { passive:false });
    frame.removeEventListener('pointerup',   st._handlers.onUp,   { passive:false });
    frame.removeEventListener('pointercancel',st._handlers.onUp,  { passive:false });
    st._handlers = null;
  }
}

let zoomedFrame = null;
btnZoom.addEventListener('click', ()=>{
  // 現在ページのframe
  const i = indexByScroll();
  const frame = sections[i]?.querySelector('.frame');
  if (!frame) return;

  if (zoomedFrame && zoomedFrame !== frame){
    // 他のページがズーム中なら先に戻す
    exitZoom(zoomedFrame);
  }

  if (btnZoom.textContent === '2倍'){
    enterZoom(frame);
    zoomedFrame = frame;
    btnZoom.textContent = '1倍';
  } else {
    exitZoom(frame);
    zoomedFrame = null;
    btnZoom.textContent = '2倍';
  }
});

/* ====== ページ外での2本指・ピンチ（念のため）を抑止 ====== */
window.addEventListener('touchstart', (e) => {
  if (e.touches.length > 1) e.preventDefault();
}, { passive:false });

/* ========= 初期化 ========= */
(function init(){
  // 原寸リンクを1ページ目に合わせる
  const firstImg = sections[0]?.querySelector('img');
  if (firstImg) btnOpen.href = firstImg.currentSrc || firstImg.src;
  // ズーム状態でリサイズされたらクランプ
  window.addEventListener('resize', ()=>{
    if (zoomedFrame){ clamp(zoomedFrame); applyTransform(zoomedFrame); }
  });
})();
</script>
</body>
</html>
