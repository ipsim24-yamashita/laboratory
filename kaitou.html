<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; --gap: 10px; }

  html, body {
    margin: 0;
    background: #fff;
    color: #111;
    font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
    overscroll-behavior-y: contain;
    overflow-x: hidden;
    touch-action: none; /* ← 全面でタップ＆ダブルタップ禁止 */
  }

  .wrap { width: 100%; margin: 0 auto; padding: 0 12px; box-sizing: border-box; }

  /* ===== カルーセル ===== */
  .toc-dock {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    background: #fff;
    border-bottom: 1px solid #eee;
    padding: 8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100vw; /* 横幅いっぱい */
    box-sizing: border-box;
    overflow: hidden;
  }

  .btn {
    height: 34px;
    padding: 0 12px;
    border: 1px solid #ddd;
    border-radius: 999px;
    background: #f9fafb;
    color: #111;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none; /* ← 原寸ボタンの下線削除 */
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .btn:disabled { opacity: .4; cursor: default; }

  .toc-container { flex: 1; overflow: hidden; }
  .toc {
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .toc::-webkit-scrollbar { display: none; }
  .toc-list {
    display: flex;
    gap: 8px;
    padding: 0;
    margin: 0;
    list-style: none;
  }
  .toc-list a {
    display: inline-block;
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 999px;
    background: #f0f6ff;
    color: #0366d6;
    text-decoration: none;
    user-select: none;
  }
  .toc-list a.active {
    background: #e7f1ff;
    border-color: #cfe3ff;
  }

  .toolbar-right { display: flex; gap: 8px; align-items: center; }

  /* ===== 本文 ===== */
  main {
    padding-top: calc(var(--dock-h) + 12px);
    padding-bottom: 48px;
  }
  section {
    padding: 18px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .frame {
    position: relative;
    overflow: hidden;
    width: 100vw;
    max-width: 100vw;
    margin-left: calc(50% - 50vw);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    touch-action: pan-y;
  }
  .frame img {
    display: block;
    width: 100%;
    height: auto;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: none;
    transform-origin: 0 0;
    will-change: transform;
  }
  .badge {
    position: absolute;
    right: 10px;
    bottom: 10px;
    background: rgba(0, 0, 0, .55);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, .12);
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 12px;
  }
</style>
</head>
<body>
  <!-- ===== カルーセル ===== -->
  <div class="toc-dock" id="toc-dock">
    <div class="wrap">
      <div class="toc-bar">
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <div class="toc-container">
          <nav class="toc" id="toc">
            <ul class="toc-list" id="toc-list"></ul>
          </nav>
        </div>

        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE = "docs/";
const groups = [
  { prefix: "1-", start: 1, end: 15 },
  { prefix: "2-", start: 1, end: 12 },
  { prefix: "3-", start: 1, end: 11 },
];
const pad3 = n => String(n).padStart(3, "0");
const files = groups.flatMap(g =>
  Array.from({ length: g.end - g.start + 1 }, (_, i) => `${g.prefix}${pad3(g.start + i)}.jpeg`)
);

/* ========= 要素 ========= */
const tocEl = document.getElementById("toc");
const tocList = document.getElementById("toc-list");
const content = document.getElementById("content");
const btnZoom = document.getElementById("btn-zoom");
const btnOpen = document.getElementById("btn-open");
const pgPrev = document.getElementById("pg-prev");
const pgNext = document.getElementById("pg-next");
const carPrev = document.getElementById("car-prev");
const carNext = document.getElementById("car-next");

/* ========= セクション生成 ========= */
files.forEach((name, idx) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = `#p-${name.replace(/\.[^.]+$/, "")}`;
  a.textContent = name.replace(".jpeg", "");
  a.dataset.index = idx;
  if (idx === 0) a.classList.add("active");
  li.appendChild(a);
  tocList.appendChild(li);

  const sec = document.createElement("section");
  sec.dataset.index = idx;
  sec.id = `p-${name.replace(/\.[^.]+$/, "")}`;
  sec.innerHTML = `
    <figure class="frame" data-zoomable>
      <img src="${BASE}${encodeURIComponent(name)}" alt="">
      <div class="badge">1.00×</div>
    </figure>`;
  content.appendChild(sec);
});

/* ========= ダブルクリック防止 for ≪ ≫ ========= */
let lastClickTime = 0;
function safeClick(handler) {
  return () => {
    const now = Date.now();
    if (now - lastClickTime < 200) return; // 200ms以内の連打無視
    lastClickTime = now;
    handler();
  };
}
function pageSize() { return Math.max(200, tocEl.clientWidth * 0.8); }
carPrev.addEventListener("click", safeClick(() =>
  tocEl.scrollBy({ left: -pageSize(), behavior: "smooth" })
));
carNext.addEventListener("click", safeClick(() =>
  tocEl.scrollBy({ left: pageSize(), behavior: "smooth" })
));

/* ========= ページ移動 ========= */
const sections = Array.from(document.querySelectorAll("main section"));
const tocLinks = Array.from(document.querySelectorAll("#toc-list a"));
function indexByScroll() {
  const y = window.scrollY;
  let best = 0, dist = Infinity;
  sections.forEach((s, i) => {
    const d = Math.abs(s.offsetTop - y);
    if (d < dist) { dist = d; best = i; }
  });
  return best;
}
function markActive(i) {
  tocLinks.forEach((el, idx) => el.classList.toggle("active", idx === i));
  const img = sections[i]?.querySelector("img");
  if (img) btnOpen.href = img.currentSrc || img.src;
}
function scrollToSection(i, smooth = true) {
  const s = sections[i]; if (!s) return;
  window.scrollTo({ top: s.offsetTop, behavior: smooth ? "smooth" : "auto" });
  markActive(i);
}
tocLinks.forEach(a => a.addEventListener("click", e => {
  e.preventDefault();
  scrollToSection(Number(a.dataset.index));
}));
pgPrev.addEventListener("click", () => { const i = indexByScroll(); if (i > 0) scrollToSection(i - 1); });
pgNext.addEventListener("click", () => { const i = indexByScroll(); if (i < sections.length - 1) scrollToSection(i + 1); });
window.addEventListener("scroll", () => markActive(indexByScroll()), { passive: true });

/* ========= 画像ズーム（2倍↔1倍）とパン ========= */
const frameStates = new WeakMap();
function getState(f){ if(!frameStates.has(f)) frameStates.set(f,{s:1,x:0,y:0}); return frameStates.get(f);}
function apply(f){ const st=getState(f); f.querySelector("img").style.transform=`translate(${st.x}px,${st.y}px) scale(${st.s})`; f.querySelector(".badge").textContent=`${st.s.toFixed(2)}×`; }
function clamp(f){ const st=getState(f); const fw=f.clientWidth,fh=f.clientHeight; const dispW=fw*st.s,dispH=fh*st.s; const minX=Math.min(0,fw-dispW),minY=Math.min(0,fh-dispH); st.x=Math.max(minX,Math.min(0,st.x)); st.y=Math.max(minY,Math.min(0,st.y)); }

let zoomed=null;
btnZoom.addEventListener("click",()=>{
  const i=indexByScroll(),f=sections[i]?.querySelector(".frame"); if(!f)return;
  const st=getState(f);
  if(btnZoom.textContent==="2倍"){ st.s=2; st.x=0; st.y=0; document.body.style.overflow="hidden"; f.style.touchAction="none";
    let sx=0,sy=0;
    f.onpointerdown=e=>{if(e.pointerType==="touch"&&e.isPrimary===false)return;e.preventDefault();sx=e.clientX-st.x;sy=e.clientY-st.y;f.setPointerCapture(e.pointerId);};
    f.onpointermove=e=>{if(!f.hasPointerCapture(e.pointerId))return;e.preventDefault();st.x=e.clientX-sx;st.y=e.clientY-sy;clamp(f);apply(f);};
    f.onpointerup=e=>f.releasePointerCapture(e.pointerId);
    f.onpointercancel=f.onpointerup;
    btnZoom.textContent="1倍"; zoomed=f;
  }else{ st.s=1;st.x=0;st.y=0;apply(f);document.body.style.overflow="auto";f.style.touchAction="pan-y";
    f.onpointerdown=f.onpointermove=f.onpointerup=f.onpointercancel=null;
    btnZoom.textContent="2倍"; zoomed=null;
  }
  apply(f);
});

/* ========= iPad ダブルタップ拡大防止 ========= */
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 400) e.preventDefault(); // ダブルタップ防止
  lastTouchEnd = now;
}, { passive: false });

/* ========= 初期化 ========= */
markActive(0);
btnOpen.href = sections[0].querySelector("img").src;
</script>
</body>
</html>
