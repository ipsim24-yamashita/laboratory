<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; }

  html, body {
    margin: 0;
    background: #fff;
    color: #111;
    font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
    overscroll-behavior: none;
  }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 0 12px; }

  /* ===== カルーセル ===== */
  .toc-dock {
    position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    background: #fff; border-bottom: 1px solid #eee;
    padding: 8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar { display: flex; align-items: center; gap: 10px; }
  .btn {
    height: 34px; padding: 0 12px;
    border: 1px solid #ddd; border-radius: 999px;
    background: #f9fafb; color: #111; cursor: pointer;
  }
  .btn:disabled { opacity: .4; cursor: default; }
  .toc-container { flex: 1; overflow: hidden; }
  .toc { overflow-x: auto; overflow-y: hidden; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .toc::-webkit-scrollbar { display: none; }
  .toc-list { display: flex; gap: 8px; padding: 0; margin: 0; list-style: none; }
  .toc-list a {
    display: inline-block; padding: 6px 12px;
    border: 1px solid #ddd; border-radius: 999px;
    background: #f0f6ff; color: #0366d6; text-decoration: none; user-select: none;
  }
  .toc-list a.active { background: #e7f1ff; border-color: #cfe3ff; }

  .toolbar-right { display: flex; gap: 8px; align-items: center; }

  /* ===== 本文 ===== */
  main { padding-top: calc(var(--dock-h) + 12px); padding-bottom: 48px; }
  section { padding: 18px 0; border-bottom: 1px solid #f0f0f0; }

  .viewer-inner { padding: 0 12px 12px 12px; box-sizing: border-box; }
  .frame {
    position: relative; overflow: hidden;
    border: 1px solid #e5e7eb; border-radius: 12px;
    background: #fff;
    touch-action: none; /* ← 全ての標準ジェスチャを無効化 */
  }
  .frame img {
    display: block; width: 100%; height: auto;
    user-select: none; -webkit-user-drag: none; pointer-events: none;
    transform-origin: 0 0; will-change: transform;
  }
  .badge {
    position: absolute; right: 10px; bottom: 10px;
    background: rgba(0,0,0,.55); color: #fff;
    border: 1px solid rgba(255,255,255,.12);
    padding: 4px 8px; border-radius: 8px; font-size: 12px;
  }
</style>
</head>
<body>
  <!-- ===== カルーセル：4ボタン＋右端ツール ===== -->
  <div class="toc-dock" id="toc-dock">
    <div class="wrap">
      <div class="toc-bar">
        <!-- 左：カルーセル操作 -->
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <!-- 中央：ページチップ -->
        <div class="toc-container">
          <nav class="toc" id="toc">
            <ul class="toc-list" id="toc-list"></ul>
          </nav>
        </div>

        <!-- 右端：ページ送り＋ズーム操作 -->
        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE = "docs/";
const groups = [
  { prefix: "1-", start: 1, end: 15 },
  { prefix: "2-", start: 1, end: 12 },
  { prefix: "3-", start: 1, end: 11 },
];
const pad3 = n => String(n).padStart(3, "0");
const files = groups.flatMap(g =>
  Array.from({ length: g.end - g.start + 1 }, (_, i) => `${g.prefix}${pad3(g.start + i)}.jpeg`)
);

/* ========= 要素 ========= */
const tocEl = document.getElementById("toc");
const tocList = document.getElementById("toc-list");
const content = document.getElementById("content");
const btnZoom = document.getElementById("btn-zoom");
const btnOpen = document.getElementById("btn-open");
const pgPrev = document.getElementById("pg-prev");
const pgNext = document.getElementById("pg-next");
const carPrev = document.getElementById("car-prev");
const carNext = document.getElementById("car-next");

/* ========= セクション生成 ========= */
files.forEach((name, idx) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = `#p-${name.replace(/\.[^.]+$/, "")}`;
  a.textContent = name.replace(".jpeg", "");
  a.dataset.index = idx;
  if (idx === 0) a.classList.add("active");
  li.appendChild(a);
  tocList.appendChild(li);

  const sec = document.createElement("section");
  sec.dataset.index = idx;
  sec.id = `p-${name.replace(/\.[^.]+$/, "")}`;
  sec.innerHTML = `
    <div class="viewer-inner">
      <figure class="frame" data-zoomable>
        <img src="${BASE}${encodeURIComponent(name)}" alt="">
        <div class="badge">1.00×</div>
      </figure>
    </div>
  `;
  content.appendChild(sec);
});

/* ========= カルーセル操作 ========= */
function pageSize() { return Math.max(200, tocEl.clientWidth * 0.8); }
carPrev.addEventListener("click", () => tocEl.scrollBy({ left: -pageSize(), behavior: "smooth" }));
carNext.addEventListener("click", () => tocEl.scrollBy({ left: pageSize(), behavior: "smooth" }));

/* ========= ページ移動 ========= */
const sections = Array.from(document.querySelectorAll("main section"));
const tocLinks = Array.from(document.querySelectorAll("#toc-list a"));
function indexByScroll() {
  const y = window.scrollY;
  let best = 0, dist = Infinity;
  sections.forEach((s, i) => {
    const d = Math.abs(s.offsetTop - y);
    if (d < dist) { dist = d; best = i; }
  });
  return best;
}
function markActive(i) {
  tocLinks.forEach((el, idx) => el.classList.toggle("active", idx === i));
  const img = sections[i]?.querySelector("img");
  if (img) btnOpen.href = img.currentSrc || img.src;
}
function scrollToSection(i, smooth = true) {
  const s = sections[i]; if (!s) return;
  const y = s.offsetTop;
  window.scrollTo({ top: y, behavior: smooth ? "smooth" : "auto" });
  markActive(i);
}
tocLinks.forEach(a => a.addEventListener("click", e => {
  e.preventDefault();
  scrollToSection(Number(a.dataset.index));
}));
pgPrev.addEventListener("click", () => { const i = indexByScroll(); if (i > 0) scrollToSection(i - 1); });
pgNext.addEventListener("click", () => { const i = indexByScroll(); if (i < sections.length - 1) scrollToSection(i + 1); });
window.addEventListener("scroll", () => markActive(indexByScroll()), { passive: true });

/* ========= 画像ズーム処理（タップ・ピンチ禁止） ========= */
let zoomed = false;        // 2倍状態かどうか
let activeFrame = null;    // 現在ズーム中のframe
btnZoom.addEventListener("click", () => {
  const i = indexByScroll();
  const frame = sections[i].querySelector(".frame");
  const img = frame.querySelector("img");
  const badge = frame.querySelector(".badge");

  if (!zoomed) {
    // ---- 2倍化 ----
    zoomed = true;
    activeFrame = frame;
    btnZoom.textContent = "1倍";
    document.body.style.overflow = "hidden"; // ページ固定
    img.style.transform = "scale(2)";
    badge.textContent = "2.00×";

    // 1本指パン許可
    let startX = 0, startY = 0;
    let moveX = 0, moveY = 0;
    frame.addEventListener("pointerdown", onDown);
    frame.addEventListener("pointermove", onMove);
    frame.addEventListener("pointerup", onUp);
    frame.addEventListener("pointercancel", onUp);

    function onDown(e) {
      if (e.pointerType !== "touch" && e.pointerType !== "mouse") return;
      e.preventDefault();
      frame.setPointerCapture(e.pointerId);
      startX = e.clientX - moveX;
      startY = e.clientY - moveY;
    }
    function onMove(e) {
      if (!frame.hasPointerCapture(e.pointerId)) return;
      e.preventDefault();
      moveX = e.clientX - startX;
      moveY = e.clientY - startY;
      img.style.transform = `translate(${moveX}px, ${moveY}px) scale(2)`;
    }
    function onUp(e) {
      frame.releasePointerCapture(e.pointerId);
    }

  } else {
    // ---- 1倍へ戻す ----
    zoomed = false;
    btnZoom.textContent = "2倍";
    document.body.style.overflow = "auto";
    img.style.transform = "scale(1)";
    badge.textContent = "1.00×";

    // ハンドラ解除
    if (activeFrame) {
      activeFrame.replaceWith(activeFrame.cloneNode(true)); // シンプルにイベント全解除
      sections[i].querySelector(".viewer-inner").replaceChild(activeFrame, sections[i].querySelector(".viewer-inner").firstChild);
    }
  }
});

/* ========= 初期化 ========= */
markActive(0);
btnOpen.href = sections[0].querySelector("img").src;
</script>
</body>
</html>
