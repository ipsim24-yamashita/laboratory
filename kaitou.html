<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; }

  html, body {
    margin: 0; background: #fff; color: #111;
    font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
    overscroll-behavior-y: contain;
    overflow-x: hidden;
    touch-action: pan-y;
  }
  .wrap { width: 100%; margin: 0 auto; padding: 0 12px; box-sizing: border-box; }

  /* ===== カルーセル ===== */
  .toc-dock {
    position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    background: #fff; border-bottom: 1px solid #eee;
    padding: 8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar {
    display: flex; align-items: center; gap: 10px;
    width: 100%; box-sizing: border-box; overflow: hidden;
  }
  .btn {
    height: 34px; padding: 0 12px; border: 1px solid #ddd;
    border-radius: 999px; background: #f9fafb; color: #111;
    cursor: pointer; font-size: 14px; text-decoration: none;
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .btn:disabled { opacity: .4; cursor: default; }

  .toc-container { flex: 1 1 auto; min-width: 0; overflow: hidden; }
  .toc {
    overflow-x: auto; overflow-y: hidden; white-space: nowrap;
    -webkit-overflow-scrolling: touch; scrollbar-width: none;
    overscroll-behavior-x: contain;
  }
  .toc::-webkit-scrollbar { display: none; }
  .toc-list { display: flex; gap: 8px; padding: 0; margin: 0; list-style: none; }
  .toc-list a {
    display: inline-block; padding: 6px 12px; border: 1px solid #ddd; border-radius: 999px;
    background: #f0f6ff; color: #0366d6; text-decoration: none; user-select: none;
  }
  .toc-list a.active { background: #e7f1ff; border-color: #cfe3ff; }
  .toolbar-right { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

  /* ===== 本文 ===== */
  main { padding-top: calc(var(--dock-h) + 12px); padding-bottom: 48px; }
  section { padding: 18px 0; border-bottom: 1px solid #f0f0f0; }

  .frame {
    position: relative; overflow: hidden;
    width: 100vw; max-width: 100vw;
    margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw);
    border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
    touch-action: pan-y;
  }
  .frame img {
    display: block; width: 100%; height: auto;
    user-select: none; -webkit-user-drag: none; pointer-events: none;
    transform-origin: 0 0; will-change: transform;
  }
  .badge {
    position: absolute; right: 10px; bottom: 10px;
    background: rgba(0,0,0,.55); color: #fff; border: 1px solid rgba(255,255,255,.12);
    padding: 4px 8px; border-radius: 8px; font-size: 12px;
  }

  /* ===== 虫眼鏡ウィンドウ ===== */
  .magnifier {
    position: absolute;
    width: 180px; height: 120px;
    border: 2px solid #22c55e; border-radius: 8px;
    overflow: hidden; pointer-events: none;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .magnifier img {
    position: absolute; width: 200%; height: 200%;
    transform-origin: top left;
  }
</style>
</head>
<body>
  <div class="toc-dock" id="toc-dock">
    <div class="wrap">
      <div class="toc-bar">
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <div class="toc-container">
          <nav class="toc" id="toc"><ul class="toc-list" id="toc-list"></ul></nav>
        </div>

        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-mag">虫眼鏡</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE = "docs/";
const groups = [
  { prefix: "1-", start: 1, end: 15 },
  { prefix: "2-", start: 1, end: 12 },
  { prefix: "3-", start: 1, end: 11 },
];
const pad3 = n => String(n).padStart(3,"0");
const files = groups.flatMap(g => Array.from({length:g.end-g.start+1},(_,i)=>`${g.prefix}${pad3(g.start+i)}.jpeg`));

const tocEl=document.getElementById('toc');
const tocList=document.getElementById('toc-list');
const content=document.getElementById('content');
const btnZoom=document.getElementById('btn-zoom');
const btnOpen=document.getElementById('btn-open');
const btnMag=document.getElementById('btn-mag');
const pgPrev=document.getElementById('pg-prev');
const pgNext=document.getElementById('pg-next');
const carPrev=document.getElementById('car-prev');
const carNext=document.getElementById('car-next');

/* ========= セクション生成 ========= */
files.forEach((name,idx)=>{
  const li=document.createElement('li');
  const a=document.createElement('a');
  a.href=`#p-${name.replace(/\.[^.]+$/,'')}`;
  a.textContent=name.replace('.jpeg','');
  a.dataset.index=idx;
  if(idx===0)a.classList.add('active');
  li.appendChild(a);tocList.appendChild(li);

  const sec=document.createElement('section');
  sec.dataset.index=idx;sec.id=`p-${name.replace(/\.[^.]+$/,'')}`;
  sec.innerHTML=`
    <figure class="frame" data-zoomable>
      <img src="${BASE}${encodeURIComponent(name)}" alt="">
      <div class="badge">1.00×</div>
      <div class="magnifier"><img src="${BASE}${encodeURIComponent(name)}" alt=""></div>
    </figure>`;
  content.appendChild(sec);
});

/* ========= 現在ページ同期 ========= */
const sections=Array.from(document.querySelectorAll('main section'));
const tocLinks=Array.from(document.querySelectorAll('#toc-list a'));
function indexByScroll(){
  const y=window.scrollY;let best=0,dist=Infinity;
  sections.forEach((s,i)=>{const d=Math.abs(s.offsetTop-y);if(d<dist){dist=d;best=i;}});
  return best;
}
function markActive(i){
  tocLinks.forEach((el,idx)=>el.classList.toggle('active',idx===i));
  const img=sections[i]?.querySelector('img');
  if(img)btnOpen.href=img.currentSrc||img.src;
}
window.addEventListener('scroll',()=>markActive(indexByScroll()),{passive:true});

/* ========= 虫眼鏡モード ========= */
let magActive=false;
let currentMag=null;
btnMag.addEventListener('click',()=>{
  const i=indexByScroll();
  const frame=sections[i]?.querySelector('.frame');
  if(!frame)return;
  const mag=frame.querySelector('.magnifier');
  const img=mag.querySelector('img');
  if(!magActive){
    mag.style.display='block';
    magActive=true;
    btnMag.textContent='オフ';
    currentMag=mag;
    // 初期位置：中央
    mag.style.left=`calc(50% - ${mag.offsetWidth/2}px)`;
    mag.style.top=`calc(50% - ${mag.offsetHeight/2}px)`;
    let dragging=false, sx=0, sy=0, startX=0, startY=0;
    frame.addEventListener('pointerdown', onDown);
    frame.addEventListener('pointermove', onMove);
    frame.addEventListener('pointerup', onUp);
    frame.addEventListener('pointercancel', onUp);
    function onDown(e){
      dragging=true;
      sx=e.clientX; sy=e.clientY;
      const r=mag.getBoundingClientRect();
      startX=r.left; startY=r.top;
      e.preventDefault();
    }
    function onMove(e){
      if(!dragging)return;
      e.preventDefault();
      const dx=e.clientX-sx, dy=e.clientY-sy;
      const nx=startX+dx, ny=startY+dy;
      const fr=frame.getBoundingClientRect();
      const mw=mag.offsetWidth, mh=mag.offsetHeight;
      const minX=fr.left, maxX=fr.right-mw, minY=fr.top, maxY=fr.bottom-mh;
      const clampedX=Math.max(minX,Math.min(maxX,nx));
      const clampedY=Math.max(minY,Math.min(maxY,ny));
      mag.style.left=`${clampedX-fr.left}px`;
      mag.style.top=`${clampedY-fr.top}px`;
      // 背景画像位置調整
      const relX=(clampedX-fr.left+mw/2)/fr.width;
      const relY=(clampedY-fr.top+mh/2)/fr.height;
      img.style.left=`-${relX*100}%`;
      img.style.top=`-${relY*100}%`;
    }
    function onUp(){ dragging=false; }
    mag._handlers={onDown,onMove,onUp};
  } else {
    mag.style.display='none';
    btnMag.textContent='虫眼鏡';
    magActive=false;
    if(currentMag && currentMag._handlers){
      const f=currentMag.closest('.frame');
      f.removeEventListener('pointerdown', currentMag._handlers.onDown);
      f.removeEventListener('pointermove', currentMag._handlers.onMove);
      f.removeEventListener('pointerup', currentMag._handlers.onUp);
      f.removeEventListener('pointercancel', currentMag._handlers.onUp);
    }
    currentMag=null;
  }
});

/* ========= 2倍ボタン（従来通り） ========= */
let zoomed=null;
btnZoom.addEventListener('click',()=>{
  const i=indexByScroll(),f=sections[i]?.querySelector('.frame');if(!f)return;
  const st={s:1,x:0,y:0};
  const img=f.querySelector('img');
  if(btnZoom.textContent==='2倍'){
    st.s=2;btnZoom.textContent='1倍';
    document.body.style.overflow='hidden';
    f.style.touchAction='none';
    let sx=0,sy=0,mx=0,my=0,drag=false;
    f.onpointerdown=e=>{drag=true;sx=e.clientX;sy=e.clientY;mx=st.x;my=st.y;f.setPointerCapture(e.pointerId);};
    f.onpointermove=e=>{if(!drag)return;st.x=mx+(e.clientX-sx);st.y=my+(e.clientY-sy);img.style.transform=`translate(${st.x}px,${st.y}px) scale(${st.s})`;};
    f.onpointerup=f.onpointercancel=()=>{drag=false;};
    img.style.transform=`scale(${st.s})`;
  }else{
    st.s=1;btnZoom.textContent='2倍';
    document.body.style.overflow='auto';
    f.style.touchAction='pan-y';
    f.onpointerdown=f.onpointermove=f.onpointerup=f.onpointercancel=null;
    img.style.transform=`scale(1)`;
  }
});

/* ========= iPadダブルタップズーム無効 ========= */
let lastTouchEnd=0;
document.addEventListener('touchend',(e)=>{
  const now=Date.now();
  if(now-lastTouchEnd<=400)e.preventDefault();
  lastTouchEnd=now;
},{passive:false});

/* ========= 初期化 ========= */
markActive(0);
btnOpen.href=sections[0].querySelector('img').src;
</script>
</body>
</html>
