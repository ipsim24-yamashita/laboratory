<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; --gap: 10px; }

  html, body{
    margin:0; background:#fff; color:#111;
    font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
    overscroll-behavior-y: contain;
    overflow-x: hidden;              /* 左右スクロール禁止 */
    touch-action: pan-y;             /* 垂直スクロールは常に可 */
  }

  .wrap{ width:100%; margin:0 auto; padding:0 12px; box-sizing:border-box; }

  /* ===== カルーセル（バー全幅・右側はみ出し防止） ===== */
  .toc-dock{
    position:fixed; top:0; left:0; right:0; z-index:1000;
    background:#fff; border-bottom:1px solid #eee;
    padding:8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar{
    display:flex; align-items:center; gap:10px;
    width:100%; box-sizing:border-box; overflow:hidden;   /* 100%で wrap 内に収める */
  }
  .btn{
    height:34px; padding:0 12px; border:1px solid #ddd; border-radius:999px;
    background:#f9fafb; color:#111; cursor:pointer; font-size:14px;
    text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    flex-shrink:0; /* 右端ボタン群が潰れない */
  }
  .btn:disabled{ opacity:.4; cursor:default; }

  .toc-container{ flex:1 1 auto; min-width:0; overflow:hidden; }
  .toc{
    overflow-x:auto; overflow-y:hidden; white-space:nowrap;
    -webkit-overflow-scrolling:touch; scrollbar-width:none;
    overscroll-behavior-x: contain;  /* 末尾のバウンス軽減 */
  }
  .toc::-webkit-scrollbar{ display:none; }
  .toc-list{ display:flex; gap:8px; padding:0; margin:0; list-style:none; }
  .toc-list a{
    display:inline-block; padding:6px 12px; border:1px solid #ddd; border-radius:999px;
    background:#f0f6ff; color:#0366d6; text-decoration:none; user-select:none;
  }
  .toc-list a.active{ background:#e7f1ff; border-color:#cfe3ff; }

  .toolbar-right{ display:flex; gap:8px; align-items:center; flex-shrink:0; } /* 右端は縮めない */

  /* ===== 本文 ===== */
  main{ padding-top: calc(var(--dock-h) + 12px); padding-bottom:48px; }
  section{ padding:18px 0; border-bottom:1px solid #f0f0f0; }

  /* 画像枠：画面幅いっぱい（フルブリード） */
  .frame{
    position:relative; overflow:hidden;
    width:100vw; max-width:100vw;
    margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw);
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    touch-action: pan-y;            /* 1倍時は縦スクロール可 */
  }
  .frame img{
    display:block; width:100%; height:auto;
    user-select:none; -webkit-user-drag:none; pointer-events:none;
    transform-origin:0 0; will-change:transform;
  }
  .badge{
    position:absolute; right:10px; bottom:10px;
    background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.12);
    padding:4px 8px; border-radius:8px; font-size:12px;
  }
</style>
</head>
<body>
  <!-- ===== カルーセル（4ボタン＋チップ＋右端ツール） ===== -->
  <div class="toc-dock" id="toc-dock">
    <div class="wrap">
      <div class="toc-bar">
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <div class="toc-container">
          <nav class="toc" id="toc">
            <ul class="toc-list" id="toc-list"></ul>
          </nav>
        </div>

        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE = "docs/";
const groups = [
  { prefix: "1-", start: 1, end: 15 },
  { prefix: "2-", start: 1, end: 12 },
  { prefix: "3-", start: 1, end: 11 },
];
const pad3 = n => String(n).padStart(3,"0");
const files = groups.flatMap(g => Array.from({length:g.end-g.start+1},(_,i)=>`${g.prefix}${pad3(g.start+i)}.jpeg`));

/* ========= 要素 ========= */
const tocEl   = document.getElementById('toc');
const tocList = document.getElementById('toc-list');
const content = document.getElementById('content');
const btnOpen = document.getElementById('btn-open');
const btnZoom = document.getElementById('btn-zoom');
const pgPrev  = document.getElementById('pg-prev');
const pgNext  = document.getElementById('pg-next');
const carPrev = document.getElementById('car-prev');
const carNext = document.getElementById('car-next');

/* ========= セクション生成 ========= */
files.forEach((name, idx) => {
  // TOC チップ
  const li = document.createElement('li');
  const a  = document.createElement('a');
  a.href = `#p-${name.replace(/\.[^.]+$/, "")}`;
  a.textContent = name.replace('.jpeg','');
  a.dataset.index = idx;
  if (idx === 0) a.classList.add('active');
  li.appendChild(a); tocList.appendChild(li);

  // 画像セクション
  const sec = document.createElement('section');
  sec.dataset.index = idx; sec.id = `p-${name.replace(/\.[^.]+$/, "")}`;
  sec.innerHTML = `
    <figure class="frame" data-zoomable>
      <img src="${BASE}${encodeURIComponent(name)}" alt="">
      <div class="badge">1.00×</div>
    </figure>`;
  content.appendChild(sec);
});

/* ========= カルーセル高さを CSS 変数へ ========= */
const dockEl = document.getElementById('toc-dock');
function applyDockH(){ document.documentElement.style.setProperty('--dock-h', (dockEl?.offsetHeight||0)+'px'); }
new ResizeObserver(applyDockH).observe(dockEl);
window.addEventListener('resize', applyDockH);
applyDockH();

/* ========= 現在ページ同期 ========= */
const sections = Array.from(document.querySelectorAll('main section'));
const tocLinks = Array.from(document.querySelectorAll('#toc-list a'));
function indexByScroll(){
  const y = window.scrollY;
  let best=0, dist=Infinity;
  sections.forEach((s,i)=>{ const d=Math.abs(s.offsetTop - y); if(d<dist){dist=d; best=i;} });
  return best;
}
function markActive(i){
  tocLinks.forEach((el,idx)=>el.classList.toggle('active', idx===i));
  const img = sections[i]?.querySelector('img');
  if (img) btnOpen.href = img.currentSrc || img.src;
}
function scrollToSection(i, smooth=true){
  const s = sections[i]; if (!s) return;
  window.scrollTo({ top: s.offsetTop, behavior: smooth?'smooth':'auto' });
  markActive(i);
}
tocLinks.forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); scrollToSection(Number(a.dataset.index)); }));
pgPrev.addEventListener('click', ()=>{ const i=indexByScroll(); if(i>0) scrollToSection(i-1); });
pgNext.addEventListener('click', ()=>{ const i=indexByScroll(); if(i<sections.length-1) scrollToSection(i+1); });
window.addEventListener('scroll', ()=>markActive(indexByScroll()), {passive:true});

/* ========= カルーセル左右：ダブルクリック禁止＋末尾で停止 ========= */
let lastClickTime = 0;
function safeClick(fn){
  return ()=>{ const now=Date.now(); if(now-lastClickTime<200) return; lastClickTime=now; fn(); };
}
function pageSize(){ return Math.max(200, tocEl.clientWidth * 0.8); }
carPrev.addEventListener('click', safeClick(()=> {
  tocEl.scrollBy({left:-pageSize(), behavior:'smooth'});
}));
carNext.addEventListener('click', safeClick(()=> {
  tocEl.scrollBy({left: pageSize(), behavior:'smooth'});
}));
// 手動スワイプでも“空白まで”行かないようにクランプ
tocEl.addEventListener('scroll', ()=>{
  const max = Math.max(0, tocEl.scrollWidth - tocEl.clientWidth);
  if (tocEl.scrollLeft < 0) tocEl.scrollLeft = 0;
  else if (tocEl.scrollLeft > max) tocEl.scrollLeft = max;
}, {passive:true});

/* ========= 画像ズーム（2倍↔1倍）と 2倍中の1本指パン ========= */
const frameStates = new WeakMap();   // frame -> {s,x,y,isDragging,sx,sy}
function stOf(f){ if(!frameStates.has(f)) frameStates.set(f,{s:1,x:0,y:0,isDragging:false,sx:0,sy:0}); return frameStates.get(f); }
function apply(f){ const st=stOf(f); f.querySelector('img').style.transform=`translate(${st.x}px,${st.y}px) scale(${st.s})`; f.querySelector('.badge').textContent=`${st.s.toFixed(2)}×`; }
function clamp(f){
  const st=stOf(f), fw=f.clientWidth, fh=f.clientHeight;
  const dispW=fw*st.s, dispH=fh*st.s;
  const minX=Math.min(0, fw-dispW), minY=Math.min(0, fh-dispH);
  st.x=Math.max(minX, Math.min(0, st.x));
  st.y=Math.max(minY, Math.min(0, st.y));
}
let zoomedFrame=null;

btnZoom.addEventListener('click', ()=>{
  const i=indexByScroll(), f=sections[i]?.querySelector('.frame'); if(!f) return;
  const st=stOf(f);
  if (btnZoom.textContent === '2倍') {
    // 2倍へ
    st.s=2; st.x=0; st.y=0; clamp(f); apply(f);
    // ページスクロールを止め、画像だけパン
    document.documentElement.style.overflowY='hidden';
    document.body.style.overflowY='hidden';
    f.style.touchAction='none';
    const onDown = (e)=>{ e.preventDefault(); st.isDragging=true; f.setPointerCapture(e.pointerId); st.sx=e.clientX-st.x; st.sy=e.clientY-st.y; };
    const onMove = (e)=>{ if(!st.isDragging) return; e.preventDefault(); st.x=e.clientX-st.sx; st.y=e.clientY-st.sy; clamp(f); apply(f); };
    const onUp   = (e)=>{ st.isDragging=false; try{ f.releasePointerCapture(e.pointerId);}catch(_){} };
    st._h={onDown,onMove,onUp};
    f.addEventListener('pointerdown', onDown, {passive:false});
    f.addEventListener('pointermove', onMove, {passive:false});
    f.addEventListener('pointerup',   onUp,   {passive:false});
    f.addEventListener('pointercancel',onUp,  {passive:false});
    btnZoom.textContent='1倍';
    zoomedFrame=f;
  } else {
    // 1倍へ
    st.s=1; st.x=0; st.y=0; apply(f);
    document.documentElement.style.overflowY='auto';
    document.body.style.overflowY='auto';
    f.style.touchAction='pan-y';                // 画像上でも1本指スクロール可
    if (st._h){
      f.removeEventListener('pointerdown', st._h.onDown, {passive:false});
      f.removeEventListener('pointermove', st._h.onMove, {passive:false});
      f.removeEventListener('pointerup',   st._h.onUp,   {passive:false});
      f.removeEventListener('pointercancel',st._h.onUp,  {passive:false});
      st._h=null;
    }
    btnZoom.textContent='2倍';
    zoomedFrame=null;
  }
});

/* ========= ダブルタップ拡大の無効化（iOS対策） ========= */
let lastTouchEnd = 0;
document.addEventListener('touchend', (e)=>{
  const now=Date.now();
  if (now - lastTouchEnd <= 400) e.preventDefault(); // ダブルタップを無効化
  lastTouchEnd = now;
}, {passive:false});

/* ========= 初期化 ========= */
(function init(){
  const firstImg = sections[0]?.querySelector('img');
  if (firstImg) btnOpen.href = firstImg.currentSrc || firstImg.src;
  // リサイズ時に2倍中ならパン範囲を再計算
  window.addEventListener('resize', ()=>{ if(zoomedFrame){ clamp(zoomedFrame); apply(zoomedFrame); } });
})();
</script>
</body>
</html>
