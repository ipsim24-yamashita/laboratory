<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>GENESIS 解答ビューア</title>
<style>
  :root { --dock-h: 0px; }

  html, body{
    margin:0; background:#fff; color:#111;
    font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
    overscroll-behavior-y: contain; overflow-x:hidden;
    touch-action: pan-y;
  }
  .wrap{ width:100%; margin:0 auto; padding:0 12px; box-sizing:border-box; }

  /* ===== カルーセル ===== */
  .toc-dock{
    position:fixed; top:0; left:0; right:0; z-index:1000;
    background:#fff; border-bottom:1px solid #eee;
    padding:8px 0 env(safe-area-inset-top) 0;
  }
  .toc-bar{
    display:flex; align-items:center; gap:10px;
    width:100%; box-sizing:border-box; overflow:hidden;
  }
  .btn{
    height:34px; padding:0 12px; border:1px solid #ddd; border-radius:999px;
    background:#f9fafb; color:#111; cursor:pointer; font-size:14px;
    text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    flex-shrink:0;
  }
  .btn:disabled{ opacity:.4; cursor:default; }

  .toc-container{ flex:1 1 auto; min-width:0; overflow:hidden; }
  .toc{
    overflow-x:auto; overflow-y:hidden; white-space:nowrap;
    -webkit-overflow-scrolling:touch; scrollbar-width:none; overscroll-behavior-x:contain;
  }
  .toc::-webkit-scrollbar{ display:none; }
  .toc-list{ display:flex; gap:8px; padding:0; margin:0; list-style:none; }
  .toc-list a{
    display:inline-block; padding:6px 12px; border:1px solid #ddd; border-radius:999px;
    background:#f0f6ff; color:#0366d6; text-decoration:none; user-select:none;
  }
  .toc-list a.active{ background:#e7f1ff; border-color:#cfe3ff; }

  .toolbar-right{ display:flex; gap:8px; align-items:center; flex-shrink:0; }

  /* ===== 本文 ===== */
  main{ padding-top: calc(var(--dock-h) + 12px); padding-bottom:48px; }
  section{ padding:18px 0; border-bottom:1px solid #f0f0f0; }

  /* 画像フレーム：画面幅いっぱい */
  .frame{
    position:relative; overflow:hidden;
    width:100vw; max-width:100vw;
    margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw);
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    touch-action: pan-y; /* 1倍時は縦スクロールOK（ズーム/虫眼鏡時はJSでnoneへ） */
  }
  .frame img{
    display:block; width:100%; height:auto;
    user-select:none; -webkit-user-drag:none; pointer-events:none;
    transform-origin:0 0; will-change:transform;
  }

  /* ===== 虫眼鏡（背景オフセット＋エッジ・グラデーション） ===== */
  .magnifier{
    position:absolute; display:none; pointer-events:none;
    width:20vw; height:20vh;           /* 画面の1/5 */
    border:2px solid #22c55e; border-radius:8px; overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.25);
    background-repeat:no-repeat;
    /* background-image / size / position はJSで設定 */
  }
  /* 常時わずかな内側フェザー（視認性UP） */
  .magnifier::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      linear-gradient(to right, rgba(255,255,255,.20), rgba(255,255,255,0) 16px 100%),
      linear-gradient(to left,  rgba(255,255,255,.20), rgba(255,255,255,0) 16px 100%),
      linear-gradient(to bottom,rgba(255,255,255,.20), rgba(255,255,255,0) 16px 100%),
      linear-gradient(to top,   rgba(255,255,255,.20), rgba(255,255,255,0) 16px 100%);
    mix-blend-mode: multiply;
  }
  /* 左端に寄ったときは左側だけ強めのフェザーで端の文字を見やすく */
  .magnifier.edge-left::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: linear-gradient(to right, rgba(255,255,255,.35), rgba(255,255,255,0) 24px);
    mix-blend-mode: multiply;
  }
</style>
</head>
<body>
  <!-- ===== カルーセル（4ボタン＋チップ＋右端ツール） ===== -->
  <div class="toc-dock" id="toc-dock">
    <div class="wrap">
      <div class="toc-bar">
        <button class="btn" id="car-prev">≪</button>
        <button class="btn" id="car-next">≫</button>

        <div class="toc-container">
          <nav class="toc" id="toc">
            <ul class="toc-list" id="toc-list"></ul>
          </nav>
        </div>

        <div class="toolbar-right">
          <button class="btn" id="pg-prev">←</button>
          <button class="btn" id="pg-next">→</button>
          <button class="btn" id="btn-mag">虫眼鏡</button>
          <button class="btn" id="btn-zoom">2倍</button>
          <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener">原寸</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" id="content"></main>

<script>
/* ========= 画像リスト ========= */
const BASE="docs/";
const groups=[{prefix:"1-",start:1,end:15},{prefix:"2-",start:1,end:12},{prefix:"3-",start:1,end:11}];
const pad3=n=>String(n).padStart(3,"0");
const files=groups.flatMap(g=>Array.from({length:g.end-g.start+1},(_,i)=>`${g.prefix}${pad3(g.start+i)}.jpeg`));

/* ========= 要素 ========= */
const tocEl=document.getElementById('toc');
const tocList=document.getElementById('toc-list');
const content=document.getElementById('content');
const btnOpen=document.getElementById('btn-open');
const btnZoom=document.getElementById('btn-zoom');
const btnMag=document.getElementById('btn-mag');
const pgPrev=document.getElementById('pg-prev');
const pgNext=document.getElementById('pg-next');
const carPrev=document.getElementById('car-prev');
const carNext=document.getElementById('car-next');

/* ========= DOM生成 ========= */
files.forEach((name,idx)=>{
  // TOC
  const li=document.createElement('li');
  const a=document.createElement('a');
  a.href=`#p-${name.replace(/\.[^.]+$/,'')}`;
  a.dataset.index=idx;
  a.textContent=name.replace('.jpeg','');
  if(idx===0)a.classList.add('active');
  li.appendChild(a); tocList.appendChild(li);

  // セクション
  const sec=document.createElement('section');
  sec.dataset.index=idx; sec.id=`p-${name.replace(/\.[^.]+$/,'')}`;
  sec.innerHTML=`
    <figure class="frame">
      <img src="${BASE}${encodeURIComponent(name)}" alt="">
      <div class="magnifier"></div>
    </figure>`;
  content.appendChild(sec);
});

/* ========= カルーセル高さを CSS 変数へ ========= */
const dockEl=document.getElementById('toc-dock');
function applyDockH(){ document.documentElement.style.setProperty('--dock-h',(dockEl?.offsetHeight||0)+'px'); }
new ResizeObserver(applyDockH).observe(dockEl); window.addEventListener('resize',applyDockH); applyDockH();

/* ========= 現在ページ追跡 ========= */
const sections=Array.from(document.querySelectorAll('main section'));
const tocLinks=Array.from(document.querySelectorAll('#toc-list a'));
let currentIndex=0;
function setActive(i){
  currentIndex=i;
  tocLinks.forEach((el,idx)=>el.classList.toggle('active', idx===i));
  const img=sections[i]?.querySelector('img');
  if(img) btnOpen.href=img.currentSrc||img.src;
  pgPrev.disabled = (i<=0);
  pgNext.disabled = (i>=sections.length-1);
}
const io=new IntersectionObserver(entries=>{
  let best=currentIndex, bestDelta=Infinity, mid=window.innerHeight/2;
  for(const e of entries){
    if(!e.isIntersecting) continue;
    const idx=Number(e.target.dataset.index);
    const delta=Math.abs(e.target.getBoundingClientRect().top - mid);
    if(delta<bestDelta){ bestDelta=delta; best=idx; }
  }
  if(best!==currentIndex) setActive(best);
},{root:null, threshold:[0,1], rootMargin:`-40% 0px -40% 0px`});
sections.forEach(s=>io.observe(s));

function scrollToSection(i, smooth=true){
  const s=sections[i]; if(!s) return;
  window.scrollTo({ top:s.offsetTop, behavior: smooth?'smooth':'auto' });
}
tocLinks.forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); scrollToSection(Number(a.dataset.index));
}));
pgPrev.addEventListener('click',()=>{ if(currentIndex>0) scrollToSection(currentIndex-1); });
pgNext.addEventListener('click',()=>{ if(currentIndex<sections.length-1) scrollToSection(currentIndex+1); });

/* ========= カルーセル左右（ダブルクリック禁止＋末尾クランプ） ========= */
let lastClickTime=0;
function safeClick(fn){ return ()=>{ const now=Date.now(); if(now-lastClickTime<200) return; lastClickTime=now; fn(); }; }
function pageSize(){ return Math.max(200, tocEl.clientWidth*0.8); }
carPrev.addEventListener('click', safeClick(()=> tocEl.scrollBy({left:-pageSize(),behavior:'smooth'})));
carNext.addEventListener('click', safeClick(()=> tocEl.scrollBy({left: pageSize(),behavior:'smooth'})));
tocEl.addEventListener('scroll', ()=>{
  const max=Math.max(0, tocEl.scrollWidth - tocEl.clientWidth);
  if (tocEl.scrollLeft < 0) tocEl.scrollLeft=0;
  else if (tocEl.scrollLeft > max) tocEl.scrollLeft=max;
}, {passive:true});

/* ========= 排反制御のユーティリティ ========= */
let zoomedFrame=null;
let magActive=false, magFrame=null;
function disablePageScroll(){ document.documentElement.style.overflowY='hidden'; document.body.style.overflowY='hidden'; }
function enablePageScroll(){ document.documentElement.style.overflowY='auto';   document.body.style.overflowY='auto';   }

/* ========= 2倍拡大（トグル、虫眼鏡と排反） ========= */
function enterZoom(frame){
  // 先に虫眼鏡をオフ（排反）
  if (magActive) exitMagnifier(magFrame);

  const img=frame.querySelector('img');
  img.style.transform=`translate(0px,0px) scale(2)`;

  disablePageScroll();
  frame.style.touchAction='none';

  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  function onDown(e){ e.preventDefault(); dragging=true; frame.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; const m=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)\s*scale\(\s*2\s*\)/.exec(img.style.transform); ox=m?parseFloat(m[1]):0; oy=m?parseFloat(m[2]):0; }
  function onMove(e){ if(!dragging) return; e.preventDefault(); const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy); img.style.transform=`translate(${nx}px,${ny}px) scale(2)`; }
  function onUp(e){ dragging=false; try{ frame.releasePointerCapture(e.pointerId);}catch(_){ } }

  frame.addEventListener('pointerdown', onDown, {passive:false});
  frame.addEventListener('pointermove', onMove, {passive:false});
  frame.addEventListener('pointerup', onUp, {passive:false});
  frame.addEventListener('pointercancel', onUp, {passive:false});
  frame._zoomHandlers={onDown,onMove,onUp};
  zoomedFrame=frame;
  btnZoom.textContent='1倍';
}
function exitZoom(frame){
  const img=frame.querySelector('img');
  img.style.transform='scale(1)';

  enablePageScroll();
  frame.style.touchAction='pan-y';

  if(frame._zoomHandlers){
    frame.removeEventListener('pointerdown', frame._zoomHandlers.onDown, {passive:false});
    frame.removeEventListener('pointermove', frame._zoomHandlers.onMove, {passive:false});
    frame.removeEventListener('pointerup',   frame._zoomHandlers.onUp,   {passive:false});
    frame.removeEventListener('pointercancel',frame._zoomHandlers.onUp,  {passive:false});
    frame._zoomHandlers=null;
  }
  zoomedFrame=null;
  btnZoom.textContent='2倍';
}
btnZoom.addEventListener('click', ()=>{
  const frame=sections[currentIndex]?.querySelector('.frame'); if(!frame) return;
  if (zoomedFrame && zoomedFrame!==frame) exitZoom(zoomedFrame);
  if (btnZoom.textContent==='2倍') enterZoom(frame); else exitZoom(frame);
});

/* ========= 虫眼鏡（2倍、排反・スクロール停止・端まで正しく映す） ========= */
function positionMagnifier(frame, mag, left, top){
  const fr=frame.getBoundingClientRect();
  const w=mag.offsetWidth, h=mag.offsetHeight;

  // クランプ（レンズの左上をframe内に収める）
  left=Math.max(0, Math.min(fr.width - w, left));
  top =Math.max(0, Math.min(fr.height - h, top));

  // 位置反映（frame内の相対px）
  mag.style.left=`${left}px`;
  mag.style.top =`${top}px`;

  // 背景の2倍拡大（frame全体を2倍にして、そのleft/topに対応させる）
  const zoom=2;
  mag.style.backgroundPosition = `${-(left*zoom)}px ${-(top*zoom)}px`;

  // 端寄りのグラデーション（左端近いときに強化）
  if (left <= 2) mag.classList.add('edge-left'); else mag.classList.remove('edge-left');
}

function enterMagnifier(frame){
  // 先に2倍をオフ（排反）
  if (zoomedFrame) exitZoom(zoomedFrame);

  const mag=frame.querySelector('.magnifier');
  const img=frame.querySelector('img');

  // レンズサイズ（20vw/20vh）と背景（frameの2倍サイズ）
  mag.style.width='20vw'; mag.style.height='20vh';
  mag.style.backgroundImage=`url("${img.currentSrc||img.src}")`;
  mag.style.backgroundSize = `${frame.clientWidth*2}px ${frame.clientHeight*2}px`;
  mag.style.display='block';

  // 初期位置＝中央
  positionMagnifier(frame, mag, (frame.clientWidth - mag.offsetWidth)/2, (frame.clientHeight - mag.offsetHeight)/2);

  // スクロール停止、ジェスチャ切替
  disablePageScroll();
  frame.style.touchAction='none';

  let dragging=false, sx=0, sy=0, startLeft=0, startTop=0;
  function onDown(e){
    e.preventDefault(); dragging=true; frame.setPointerCapture(e.pointerId);
    const r=mag.getBoundingClientRect(), fr=frame.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; startLeft=r.left-fr.left; startTop=r.top-fr.top;
  }
  function onMove(e){
    if(!dragging) return;
    e.preventDefault();
    const dx=e.clientX - sx, dy=e.clientY - sy;
    positionMagnifier(frame, mag, startLeft + dx, startTop + dy);
  }
  function onUp(e){ dragging=false; try{ frame.releasePointerCapture(e.pointerId);}catch(_){ } }

  frame.addEventListener('pointerdown', onDown, {passive:false});
  frame.addEventListener('pointermove', onMove, {passive:false});
  frame.addEventListener('pointerup', onUp, {passive:false});
  frame.addEventListener('pointercancel', onUp, {passive:false});
  frame._magHandlers={onDown,onMove,onUp};

  magFrame=frame; magActive=true; btnMag.textContent='オフ';
}
function exitMagnifier(frame){
  const mag=frame.querySelector('.magnifier');
  mag.style.display='none';
  mag.classList.remove('edge-left');

  enablePageScroll();
  frame.style.touchAction='pan-y';

  if(frame._magHandlers){
    frame.removeEventListener('pointerdown', frame._magHandlers.onDown, {passive:false});
    frame.removeEventListener('pointermove', frame._magHandlers.onMove, {passive:false});
    frame.removeEventListener('pointerup',   frame._magHandlers.onUp,   {passive:false});
    frame.removeEventListener('pointercancel',frame._magHandlers.onUp,  {passive:false});
    frame._magHandlers=null;
  }
  magFrame=null; magActive=false; btnMag.textContent='虫眼鏡';
}

btnMag.addEventListener('click', ()=>{
  const frame=sections[currentIndex]?.querySelector('.frame'); if(!frame) return;
  if (magActive && magFrame===frame) exitMagnifier(frame);
  else {
    if (magActive && magFrame && magFrame!==frame) exitMagnifier(magFrame);
    enterMagnifier(frame);
  }
});

/* ========= ダブルタップ拡大の無効化（iOS対策） ========= */
let lastTouchEnd=0;
document.addEventListener('touchend',(e)=>{
  const now=Date.now();
  if(now-lastTouchEnd<=400) e.preventDefault();
  lastTouchEnd=now;
},{passive:false});

/* ========= 初期化 ========= */
(function init(){
  // TOC生成後に setActive(0)
  setActive(0);
})();
</script>
</body>
</html>
