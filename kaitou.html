<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>解答画像ビューア</title>
  <style>
    :root { --wrap-w: 1100px; --gap: 16px; }
    body { margin: 0; font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif; color:#111; line-height:1.6; }
    header { position: sticky; top: 0; z-index: 10; background: rgba(255,255,255,.9); backdrop-filter: blur(8px); border-bottom: 1px solid #eee; }
    .wrap { max-width: var(--wrap-w); margin: 0 auto; padding: 14px; }
    h1 { font-size: 1.1rem; margin: 0 0 8px; }
    nav { overflow-x:auto; }
    nav ul { display:flex; flex-wrap:wrap; gap:8px; padding:0; margin:0; list-style:none; }
    nav a { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius: 999px; text-decoration:none; color:#0366d6; background:#f9fbff; white-space:nowrap; }
    main { padding-bottom: 60px; }
    section { padding: 22px 0; border-bottom: 1px solid #f5f5f5; }
    section h2 { font-size:.95rem; margin:0 0 8px; color:#333; }
    figure { margin:0; }
    .frame {
      width:100%; overflow:hidden; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
      touch-action: none; /* pinch/drag を JS で扱うため */
    }
    .frame img {
      display:block; width:100%; height:auto; user-select:none; -webkit-user-drag:none; touch-action: none;
      transform-origin: 0 0; /* JS で原点を調整 */
    }
    .tools { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 0; }
    .tools a { font-size:.9rem; text-decoration:none; color:#333; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fafafa; }
    .toplink { text-align:right; margin-top:8px; }
    .toplink a { text-decoration:none; color:#06f; }
    .hint { font-size:.85rem; color:#666; margin:6px 0 0; }
  </style>
</head>
<body>
<header id="top">
  <div class="wrap">
    <h1>解答画像ビューア（最上段の目次から各ページへジャンプ）</h1>
    <nav aria-label="目次">
      <ul id="toc"></ul>
    </nav>
  </div>
</header>

<main class="wrap" id="content">
  <!-- JS で自動生成 -->
</main>

<script>
  // ====== 設定 ======
  const BASE = "docs/"; // 画像フォルダ
  // 1-001〜1-015, 2-001〜2-012, 3-001〜3-011 を想定。必要に応じて変更してください。
  const groups = [
    { prefix: "1-", start: 1, end: 15 },
    { prefix: "2-", start: 1, end: 12 },
    { prefix: "3-", start: 1, end: 11 },
  ];

  const pad3 = n => String(n).padStart(3, "0");
  const files = groups.flatMap(g => Array.from({length: g.end - g.start + 1}, (_,i)=>`${g.prefix}${pad3(g.start+i)}.jpeg`));

  // ====== 目次 & 本文 生成 ======
  const toc = document.getElementById("toc");
  const content = document.getElementById("content");

  files.forEach((name, idx) => {
    const id = `p-${name.replace(/\.[^.]+$/, "")}`; // "p-1-001" など

    // TOC
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = `#${id}`;
    a.textContent = name.replace(".jpeg","");
    li.appendChild(a);
    toc.appendChild(li);

    // Section
    const sec = document.createElement("section");
    sec.id = id;
    sec.innerHTML = `
      <h2>${idx+1}. ${name}</h2>
      <figure class="frame" data-zoomable>
        <img src="${BASE}${name}" alt="${name}">
      </figure>
      <p class="hint">ピンチで拡大／2本指ドラッグで移動／ダブルタップでリセット</p>
      <div class="tools">
        <a href="${BASE}${name}" download>画像をダウンロード</a>
        <a href="${BASE}${name}" target="_blank" rel="noopener">原寸で開く</a>
      </div>
      <p class="toplink"><a href="#top">▲ 目次へ戻る</a></p>
    `;
    content.appendChild(sec);
  });

  // ====== 軽量ピンチズーム（Pointer Events） ======
  // 各 .frame に対して、ピンチで scale、ドラッグで pan。ダブルタップでリセット。
  document.querySelectorAll('[data-zoomable]').forEach(initZoomable);

  function initZoomable(frame){
    const img = frame.querySelector('img');
    let pointers = new Map(); // pointerId -> {x,y}
    let baseScale = 1, baseX = 0, baseY = 0; // 累積
    let liveScale = 1, liveX = 0, liveY = 0; // 一時（操作中）
    let lastTap = 0;

    const setTransform = () => {
      const s = baseScale * liveScale;
      const tx = baseX + liveX;
      const ty = baseY + liveY;
      img.style.transform = `translate(${tx}px, ${ty}px) scale(${s})`;
    };

    const rectClientToImage = (clientX, clientY) => {
      const r = frame.getBoundingClientRect();
      return { x: clientX - r.left, y: clientY - r.top };
    };

    const distance = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
    const midpoint = (a,b)=> ({ x:(a.x+b.x)/2, y:(a.y+b.y)/2 });

    let pinchStart = null; // {d, mid}
    frame.addEventListener('pointerdown', e => {
      frame.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, rectClientToImage(e.clientX, e.clientY));

      // ダブルタップ（素早く2回）
      const now = performance.now();
      if (now - lastTap < 300 && pointers.size === 1) {
        baseScale = 1; baseX = 0; baseY = 0;
        liveScale = 1; liveX = 0; liveY = 0;
        setTransform(); lastTap = 0; return;
      }
      lastTap = now;
    });

    frame.addEventListener('pointermove', e => {
      if (!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, rectClientToImage(e.clientX, e.clientY));

      if (pointers.size === 2) {
        const [p1, p2] = [...pointers.values()];
        const mid = midpoint(p1,p2);
        const d = distance(p1,p2);
        if (!pinchStart) {
          pinchStart = { d, mid, baseScaleAtStart: baseScale, baseXAtStart: baseX, baseYAtStart: baseY };
          // 原点をピンチ中心に近づける
          const imgRect = frame.getBoundingClientRect();
          const ox = (mid.x - baseX) / baseScale;
          const oy = (mid.y - baseY) / baseScale;
          img.style.transformOrigin = `${ox}px ${oy}px`;
        } else {
          liveScale = d / pinchStart.d;
          // 拡大縮小中はパンも少し追従
          const s = pinchStart.baseScaleAtStart * liveScale;
          const dx = (mid.x - pinchStart.mid.x);
          const dy = (mid.y - pinchStart.mid.y);
          liveX = dx; liveY = dy;
        }
        setTransform();
      } else if (pointers.size === 1) {
        // 1本指ドラッグ（パン）
        const p = [...pointers.values()][0];
        if (!pinchStart) { // 通常パン
          liveX = p._lastX !== undefined ? (p.x - p._lastX) : 0;
          liveY = p._lastY !== undefined ? (p.y - p._lastY) : 0;
          p._lastX = p.x; p._lastY = p.y;
          setTransform();
        }
      }
    });

    const endGesture = id => {
      const hadTwo = pointers.size === 2;
      pointers.delete(id);
      if (hadTwo || pinchStart) {
        // ピンチ確定
        baseScale *= liveScale; baseX += liveX; baseY += liveY;
        liveScale = 1; liveX = 0; liveY = 0; pinchStart = null;
        setTransform();
      } else if ([liveX, liveY].some(v => v !== 0)) {
        // パン確定
        baseX += liveX; baseY += liveY; liveX = 0; liveY = 0; setTransform();
      }
    };

    frame.addEventListener('pointerup', e => endGesture(e.pointerId));
    frame.addEventListener('pointercancel', e => endGesture(e.pointerId));
    frame.addEventListener('wheel', e => {
      // マウスホイールで拡大縮小（Ctrl+/pinch trackpad）
      if (!e.ctrlKey) return;
      e.preventDefault();
      const { x, y } = rectClientToImage(e.clientX, e.clientY);
      const scaleDelta = Math.exp(-e.deltaY * 0.002);
      const newScale = baseScale * scaleDelta;

      // 原点をカーソル位置に
      const ox = (x - baseX) / baseScale;
      const oy = (y - baseY) / baseScale;
      img.style.transformOrigin = `${ox}px ${oy}px`;

      baseScale = newScale;
      setTransform();
    }, { passive:false });
  }

  // アンカーをスムーズに
  document.querySelectorAll('a[href^="#"]').forEach(a=>{
    a.addEventListener('click', e=>{
      const id = a.getAttribute('href');
      const el = document.querySelector(id);
      if(!el) return;
      e.preventDefault();
      el.scrollIntoView({behavior:'smooth', block:'start'});
      history.pushState(null, "", id);
    });
  });
</script>
</body>
</html>
