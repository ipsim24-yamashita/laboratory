<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <title>GENESIS 解答ビューア</title>
    <style>
      :root {
        --dock-h: 0px;
      }

      html,
      body {
        margin: 0;
        background: #fff;
        color: #111;
        font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
        overscroll-behavior-y: contain;
        overflow-x: hidden;
        touch-action: pan-y;
      }
      .wrap {
        width: 100%;
        margin: 0 auto;
        padding: 0 12px;
        box-sizing: border-box;
      }

      /* ===== カルーセル ===== */
      .toc-dock {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: #fff;
        border-bottom: 1px solid #eee;
        padding: 8px 0 env(safe-area-inset-top) 0;
      }
      .toc-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
      }
      .btn {
        height: 34px;
        padding: 0 12px;
        border: 1px solid #ddd;
        border-radius: 999px;
        background: #f9fafb;
        color: #111;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .btn:disabled {
        opacity: 0.4;
        cursor: default;
      }

      .toc-container {
        flex: 1 1 auto;
        min-width: 0;
        overflow: hidden;
      }
      .toc {
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        overscroll-behavior-x: contain;
      }
      .toc::-webkit-scrollbar {
        display: none;
      }
      .toc-list {
        display: flex;
        gap: 8px;
        padding: 0;
        margin: 0;
        list-style: none;
      }
      .toc-list a {
        display: inline-block;
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 999px;
        background: #f0f6ff;
        color: #0366d6;
        text-decoration: none;
        user-select: none;
      }
      .toc-list a.active {
        background: #e7f1ff;
        border-color: #cfe3ff;
      }

      .toolbar-right {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-shrink: 0;
      }

      /* ===== 本文 ===== */
      main {
        padding-top: calc(var(--dock-h) + 12px);
        padding-bottom: 48px;
      }
      section {
        padding: 18px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      /* 画像フレーム：画面幅いっぱい */
      .frame {
        position: relative;
        overflow: hidden;
        width: 100vw;
        max-width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        touch-action: pan-y;
      }
      .frame img {
        display: block;
        width: 100%;
        height: auto;
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;
        transform-origin: 0 0;
        will-change: transform;
      }

      /* ===== 虫眼鏡（50%サイズ、四辺グラデーション） ===== */
      .magnifier {
        position: absolute;
        display: none;
        pointer-events: none;
        width: 50vw;
        height: 50vh;
        border: 2px solid #22c55e;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        background-repeat: no-repeat;
      }
      .magnifier::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
            to right,
            rgba(255, 255, 255, var(--gL, 0)),
            rgba(255, 255, 255, 0) 32px
          ),
          linear-gradient(
            to left,
            rgba(255, 255, 255, var(--gR, 0)),
            rgba(255, 255, 255, 0) 32px
          ),
          linear-gradient(
            to bottom,
            rgba(255, 255, 255, var(--gT, 0)),
            rgba(255, 255, 255, 0) 32px
          ),
          linear-gradient(
            to top,
            rgba(255, 255, 255, var(--gB, 0)),
            rgba(255, 255, 255, 0) 32px
          );
        mix-blend-mode: multiply;
      }
    </style>
  </head>
  <body>
    <!-- ===== カルーセル ===== -->
    <div class="toc-dock" id="toc-dock">
      <div class="wrap">
        <div class="toc-bar">
          <button class="btn" id="car-prev">≪</button>
          <button class="btn" id="car-next">≫</button>

          <div class="toc-container">
            <nav class="toc" id="toc">
              <ul class="toc-list" id="toc-list"></ul>
            </nav>
          </div>

          <div class="toolbar-right">
            <button class="btn" id="pg-prev">←</button>
            <button class="btn" id="pg-next">→</button>
            <button class="btn" id="btn-mag">虫眼鏡</button>
            <button class="btn" id="btn-zoom">2倍</button>
            <a class="btn" id="btn-open" href="#" target="_blank" rel="noopener"
              >原寸</a
            >
          </div>
        </div>
      </div>
    </div>

    <main class="wrap" id="content"></main>

    <script>
      /* ========= 画像リスト ========= */
      const BASE = "docs/";
      const groups = [
        { prefix: "1-", start: 1, end: 15 },
        { prefix: "2-", start: 1, end: 12 },
        { prefix: "3-", start: 1, end: 11 },
      ];
      const pad3 = (n) => String(n).padStart(3, "0");
      const files = groups.flatMap((g) =>
        Array.from(
          { length: g.end - g.start + 1 },
          (_, i) => `${g.prefix}${pad3(g.start + i)}.jpeg`
        )
      );

      /* ========= DOM構築 ========= */
      const tocList = document.getElementById("toc-list");
      const content = document.getElementById("content");
      files.forEach((name, idx) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `#p-${name.replace(/\.[^.]+$/, "")}`;
        a.dataset.index = idx;
        a.textContent = name.replace(".jpeg", "");
        if (idx === 0) a.classList.add("active");
        li.appendChild(a);
        tocList.appendChild(li);

        const sec = document.createElement("section");
        sec.dataset.index = idx;
        sec.id = `p-${name.replace(/\.[^.]+$/, "")}`;
        sec.innerHTML = `
    <figure class="frame">
      <img src="${BASE}${encodeURIComponent(name)}" alt="">
      <div class="magnifier"></div>
    </figure>`;
        content.appendChild(sec);
      });

      /* ========= ページ判定・リンク反映 ========= */
      const sections = Array.from(document.querySelectorAll("main section"));
      const tocLinks = Array.from(document.querySelectorAll("#toc-list a"));
      let currentIndex = 0;
      function setActive(i) {
        currentIndex = i;
        tocLinks.forEach((el, idx) => el.classList.toggle("active", idx === i));
        const img = sections[i]?.querySelector("img");
        if (img)
          document.getElementById("btn-open").href = img.currentSrc || img.src;
      }

      /* IntersectionObserver：中央基準の安定化 */
      const io = new IntersectionObserver(
        (entries) => {
          let best = currentIndex,
            bestDelta = Infinity;
          const mid = window.innerHeight * 0.5;
          for (const e of entries) {
            const rect = e.target.getBoundingClientRect();
            if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
            const delta = Math.abs(rect.top + rect.height / 2 - mid);
            if (delta < bestDelta) {
              bestDelta = delta;
              best = Number(e.target.dataset.index);
            }
          }
          if (best !== currentIndex) setActive(best);
        },
        { threshold: [0, 0.5, 1] }
      );
      sections.forEach((s) => io.observe(s));

      /* ========= ページ移動（瞬時） ========= */
      function scrollToSection(i) {
        const s = sections[i];
        if (s) window.scrollTo({ top: s.offsetTop, behavior: "auto" });
      }
      document.getElementById("pg-prev").onclick = () => {
        if (currentIndex > 0) scrollToSection(currentIndex - 1);
      };
      document.getElementById("pg-next").onclick = () => {
        if (currentIndex < sections.length - 1)
          scrollToSection(currentIndex + 1);
      };

      /* ========= カルーセル左右 ========= */
      const toc = document.getElementById("toc");
      function pageSize() {
        return Math.max(200, toc.clientWidth * 0.8);
      }
      document.getElementById("car-prev").onclick = () =>
        toc.scrollBy({ left: -pageSize(), behavior: "auto" });
      document.getElementById("car-next").onclick = () =>
        toc.scrollBy({ left: pageSize(), behavior: "auto" });

      /* ======== 排反制御 ======== */
      let zoomedFrame = null;
      let magFrame = null;

      /* ======== 2倍ズーム ======== */
      function enterZoom(frame) {
        if (magFrame) exitMagnifier(magFrame);
        const img = frame.querySelector("img");
        img.style.transform = `translate(0,0) scale(2)`;
        frame.style.touchAction = "none";
        let sx,
          sy,
          tx = 0,
          ty = 0;
        function move(e) {
          if (sx == null) return;
          const dx = e.clientX - sx,
            dy = e.clientY - sy;
          const maxX = img.clientWidth * 2 - frame.clientWidth;
          const maxY = img.clientHeight * 2 - frame.clientHeight;
          tx = Math.max(-maxX / 2, Math.min(maxX / 2, tx + dx));
          ty = Math.max(-maxY / 2, Math.min(maxY / 2, ty + dy));
          img.style.transform = `translate(${tx}px,${ty}px) scale(2)`;
          sx = e.clientX;
          sy = e.clientY;
        }
        frame.onpointerdown = (e) => {
          sx = e.clientX;
          sy = e.clientY;
          frame.setPointerCapture(e.pointerId);
        };
        frame.onpointermove = move;
        frame.onpointerup = (e) => {
          sx = null;
          frame.releasePointerCapture(e.pointerId);
        };
        zoomedFrame = frame;
        document.getElementById("btn-zoom").textContent = "1倍";
      }
      function exitZoom(frame) {
        const img = frame.querySelector("img");
        img.style.transform = "scale(1)";
        frame.style.touchAction = "pan-y";
        frame.onpointerdown = frame.onpointermove = frame.onpointerup = null;
        zoomedFrame = null;
        document.getElementById("btn-zoom").textContent = "2倍";
      }
      document.getElementById("btn-zoom").onclick = () => {
        const f = sections[currentIndex].querySelector(".frame");
        if (zoomedFrame && zoomedFrame !== f) exitZoom(zoomedFrame);
        if (document.getElementById("btn-zoom").textContent === "2倍")
          enterZoom(f);
        else exitZoom(f);
      };

      /* ======== 虫眼鏡（右下端揃え改良） ======== */
      function setGrad(m, l, r, t, b) {
        const s = 0.45;
        m.style.setProperty("--gL", (l * s).toFixed(3));
        m.style.setProperty("--gR", (r * s).toFixed(3));
        m.style.setProperty("--gT", (t * s).toFixed(3));
        m.style.setProperty("--gB", (b * s).toFixed(3));
      }
      function positionMag(frame, mag, x, y) {
        const fr = frame.getBoundingClientRect();
        const w = mag.offsetWidth,
          h = mag.offsetHeight;
        x = Math.max(0, Math.min(fr.width - w, x));
        y = Math.max(0, Math.min(fr.height - h, y));
        mag.style.left = `${x}px`;
        mag.style.top = `${y}px`;
        const zoom = 2;
        const bgMaxX = fr.width * zoom - w;
        const bgMaxY = fr.height * zoom - h;
        const bgX = -Math.min(x * zoom, bgMaxX);
        const bgY = -Math.min(y * zoom, bgMaxY);
        mag.style.backgroundPosition = `${bgX}px ${bgY}px`;
        const th = 96;
        const l = Math.max(0, Math.min(1, 1 - x / th));
        const r = Math.max(0, Math.min(1, 1 - (fr.width - (x + w)) / th));
        const t = Math.max(0, Math.min(1, 1 - y / th));
        const b = Math.max(0, Math.min(1, 1 - (fr.height - (y + h)) / th));
        setGrad(mag, l, r, t, b);
      }
      function enterMagnifier(frame) {
        if (zoomedFrame) exitZoom(zoomedFrame);
        const mag = frame.querySelector(".magnifier");
        const img = frame.querySelector("img");
        mag.style.backgroundImage = `url("${img.currentSrc || img.src}")`;
        mag.style.backgroundSize = `${frame.clientWidth * 2}px ${
          frame.clientHeight * 2
        }px`;
        mag.style.display = "block";
        positionMag(
          frame,
          mag,
          (frame.clientWidth - mag.offsetWidth) / 2,
          (frame.clientHeight - mag.offsetHeight) / 2
        );
        let sx, sy, l0, t0;
        frame.onpointerdown = (e) => {
          const r = mag.getBoundingClientRect(),
            f = frame.getBoundingClientRect();
          sx = e.clientX;
          sy = e.clientY;
          l0 = r.left - f.left;
          t0 = r.top - f.top;
          frame.setPointerCapture(e.pointerId);
        };
        frame.onpointermove = (e) => {
          if (sx == null) return;
          const dx = e.clientX - sx,
            dy = e.clientY - sy;
          positionMag(frame, mag, l0 + dx, t0 + dy);
        };
        frame.onpointerup = (e) => {
          sx = null;
          frame.releasePointerCapture(e.pointerId);
        };
        magFrame = frame;
        document.getElementById("btn-mag").textContent = "オフ";
      }
      function exitMagnifier(frame) {
        const mag = frame.querySelector(".magnifier");
        mag.style.display = "none";
        setGrad(mag, 0, 0, 0, 0);
        frame.onpointerdown = frame.onpointermove = frame.onpointerup = null;
        magFrame = null;
        document.getElementById("btn-mag").textContent = "虫眼鏡";
      }
      document.getElementById("btn-mag").onclick = () => {
        const f = sections[currentIndex].querySelector(".frame");
        if (magFrame && magFrame === f) exitMagnifier(f);
        else {
          if (magFrame && magFrame !== f) exitMagnifier(magFrame);
          enterMagnifier(f);
        }
      };
    </script>
  </body>
</html>
